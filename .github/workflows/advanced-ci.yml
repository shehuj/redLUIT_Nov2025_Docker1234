name: Advanced Level - Docker Compose CI

on:
  # Test only - runs on dev branch and PRs
  push:
    branches:
      - dev
    paths:
      - 'advanced/**'
      - '.github/workflows/advanced-ci.yml'
  pull_request:
    branches:
      - dev
    paths:
      - 'advanced/**'
      - '.github/workflows/advanced-ci.yml'
  workflow_dispatch:

jobs:
  validate-compose:
    name: Validate Docker Compose File
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate docker-compose.yml
        working-directory: advanced
        run: |
          docker compose version
          docker compose config --quiet

      - name: Lint docker-compose.yml with docker-compose config
        working-directory: advanced
        run: |
          # Validate syntax and configuration
          docker compose config > /dev/null
          echo "✓ docker-compose.yml is valid"

  test-advanced:
    name: Test Advanced Level - Docker Compose
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: validate-compose

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Make scripts executable
        working-directory: advanced
        run: chmod +x *.sh

      - name: Test Script 1 - Setup with Docker Compose
        working-directory: advanced
        run: |
          echo "Running Docker Compose setup..."
          ./01-setup-jenkins.sh

          echo "Waiting for Jenkins to start..."
          sleep 30

          # Verify service is running
          docker compose ps
          docker compose ps | grep jenkins_advanced | grep Up

          # Verify volume
          docker volume ls | grep jenkins_data_advanced

          echo "Waiting for Jenkins to fully initialize..."
          # Wait for Jenkins to be ready (up to 3 minutes)
          for i in {1..36}; do
            if curl -f http://localhost:8080/login 2>/dev/null; then
              echo "✅ Jenkins is responding!"
              break
            fi
            echo "Waiting for Jenkins... ($i/36)"
            sleep 5
          done

          # Final test
          curl -f http://localhost:8080/login || {
            echo "Jenkins failed to start properly. Checking logs..."
            docker compose logs --tail=100
            exit 1
          }

      - name: Test Health Check
        working-directory: advanced
        run: |
          # Wait for health check to pass
          for i in {1..10}; do
            HEALTH=$(docker inspect jenkins_advanced --format='{{.State.Health.Status}}')
            echo "Health check attempt $i: $HEALTH"
            if [ "$HEALTH" = "healthy" ]; then
              echo "Container is healthy!"
              break
            fi
            sleep 10
          done

      - name: Test Docker Compose Commands
        working-directory: advanced
        run: |
          # Test various compose commands
          docker compose logs --tail=50
          docker compose ps
          docker compose top

      - name: Test Script 2 - Verify Persistence
        working-directory: advanced
        run: |
          echo "Testing data persistence..."
          ./02-verify-persistence.sh

          echo "Waiting for container to restart..."
          sleep 30

          # Verify container is running
          docker compose ps | grep jenkins_advanced | grep Up

          echo "Waiting for Jenkins to initialize after recreation..."
          # Wait for Jenkins (up to 3 minutes)
          for i in {1..36}; do
            if curl -f http://localhost:8080/login 2>/dev/null; then
              echo "✅ Jenkins recreated successfully!"
              break
            fi
            echo "Waiting for Jenkins... ($i/36)"
            sleep 5
          done

          # Test endpoint
          curl -f http://localhost:8080/login || {
            echo "Jenkins failed after recreation. Checking logs..."
            docker compose logs --tail=100
            exit 1
          }

      - name: Test Service Restart
        working-directory: advanced
        run: |
          echo "Testing service restart..."
          docker compose restart

          echo "Waiting for restart..."
          sleep 30

          # Verify it came back up
          docker compose ps | grep jenkins_advanced | grep Up

          echo "Waiting for Jenkins after restart..."
          # Wait for Jenkins (up to 2 minutes)
          for i in {1..24}; do
            if curl -f http://localhost:8080/login 2>/dev/null; then
              echo "✅ Jenkins restarted successfully!"
              break
            fi
            echo "Waiting for Jenkins... ($i/24)"
            sleep 5
          done

          # Final test
          curl -f http://localhost:8080/login || {
            echo "Jenkins failed after restart. Checking logs..."
            docker compose logs --tail=100
            exit 1
          }

      - name: Collect Container Logs
        if: always()
        working-directory: advanced
        run: |
          echo "=== Docker Compose Logs ==="
          docker compose logs

          echo "=== Container Status ==="
          docker compose ps

      - name: Test Script 3 - Cleanup
        if: always()
        working-directory: advanced
        run: |
          echo "Running cleanup..."
          ./03-cleanup.sh

          # Verify cleanup
          ! docker compose ps 2>/dev/null | grep jenkins_advanced
          ! docker volume ls | grep jenkins_data_advanced

          echo "Cleanup Has Been Completed!."