name: Production Jenkins - Build, Scan & Publish to Docker Hub

# Builds production-grade Jenkins from complex/ and publishes to Docker Hub
# Only runs on merge to main (not on dev/PR)
on:
  push:
    branches: ["main"]
    paths:
      - 'complex/**'
      - '.github/workflows/docker-02-jenkins.yml'
  workflow_dispatch:
    inputs:
      tag_suffix:
        description: 'Optional tag suffix (e.g., -rc1, -beta)'
        required: false
        type: string

permissions:
  contents: read
  packages: write
  security-events: write
  attestations: write
  id-token: write

env:
  IMAGE_NAME: ${{ secrets.DOCKER_USERNAME }}/jenkins-custom
  DOCKERHUB_REPO: ${{ secrets.DOCKER_USERNAME }}/jenkins-custom

jobs:
  build_and_scan:
    name: Build, Test & Scan
    runs-on: ubuntu-latest

    steps:
      # ðŸ§¾ 1) Check out the code
      - name: Checkout repository
        uses: actions/checkout@v6

      # ðŸ§  2) Set up Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ðŸ”‘ 3) Log in to Docker registry
      - name: Log in to Docker registry
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # ðŸ›  4) Build production Jenkins image from complex/
      - name: Build Docker image
        run: |
          TAG=${{ github.sha }}
          docker build \
            -t ${{ env.IMAGE_NAME }}:$TAG \
            -f complex/Dockerfile complex/

      # ðŸ§ª 5) Optional â€“ Run tests (if you have any)
      - name: Run tests (optional)
        run: |
          echo "ðŸ“Œ Add your unit/integration tests here"
          # Ex: npm test, pytest, go test, etc.

      # ðŸ” 6) Trivy vulnerability scan â€“ table format
      - name: Trivy scan (table)
        uses: aquasecurity/trivy-action@0.33.1
        continue-on-error: true
        with:
          image-ref: ${{ env.IMAGE_NAME }}:${{ github.sha }}
          format: table
          ignore-unfixed: true
          severity: HIGH,CRITICAL
          exit-code: 0

      # ðŸ“Š 7) Trivy SARIF report generation
      - name: Trivy SARIF scan
        uses: aquasecurity/trivy-action@0.33.1
        continue-on-error: true
        with:
          image-ref: ${{ env.IMAGE_NAME }}:${{ github.sha }}
          format: sarif
          output: trivy-results.sarif
          ignore-unfixed: true
          severity: HIGH,CRITICAL
          exit-code: 0

      # ðŸ“‚ 8) Upload SARIF as artifact
      - name: Upload SARIF artifact
        if: always() && hashFiles('trivy-results.sarif') != ''
        uses: actions/upload-artifact@v4
        with:
          name: trivy-sarif-report
          path: trivy-results.sarif

      # ðŸ“¡ 9) Upload SARIF to GitHub Security tab (code scanning)
      - name: Upload SARIF to Security tab
        if: always() && hashFiles('trivy-results.sarif') != ''
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-results.sarif

  push_image:
    name: Push Docker Image
    runs-on: ubuntu-latest
    needs: build_and_scan

    # Only push on direct pushes (not PRs)
    if: github.event_name != 'pull_request'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker registry
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Verify Docker Hub repository exists
        run: |
          echo "â„¹ï¸ Pushing to: ${{ env.DOCKERHUB_REPO }}"
          echo "âš ï¸ Make sure the repository exists on Docker Hub first!"
          echo "   Create it at: https://hub.docker.com/repository/create"
          echo "   Repository name: jenkins-custom"
          echo "   Visibility: Public or Private"

      - name: Build and Push Production Jenkins to Docker Hub
        id: build-push
        uses: docker/build-push-action@v6
        with:
          context: complex
          file: complex/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.DOCKERHUB_REPO }}:${{ github.sha }}
            ${{ env.DOCKERHUB_REPO }}:latest
            ${{ env.DOCKERHUB_REPO }}:main
            ${{ github.event.inputs.tag_suffix && format('{0}:{1}', env.DOCKERHUB_REPO, github.event.inputs.tag_suffix) || '' }}
          labels: |
            org.opencontainers.image.title=Production Jenkins Custom
            org.opencontainers.image.description=Production-grade Jenkins with DevOps tools
            org.opencontainers.image.vendor=redLUIT
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Generate build attestation
        uses: actions/attest-build-provenance@v1
        with:
          subject-name: ${{ env.DOCKERHUB_REPO }}
          subject-digest: ${{ steps.build-push.outputs.digest }}
          push-to-registry: true

      - name: Success summary
        run: |
          echo "## âœ… Production Jenkins Published to Docker Hub" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** \`${{ env.DOCKERHUB_REPO }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Digest:** \`${{ steps.build-push.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pull Commands:**" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# Latest version" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.DOCKERHUB_REPO }}:latest" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Specific commit" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.DOCKERHUB_REPO }}:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**View on Docker Hub:** https://hub.docker.com/r/${{ env.DOCKERHUB_REPO }}" >> $GITHUB_STEP_SUMMARY