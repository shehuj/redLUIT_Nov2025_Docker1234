name: Publish All Docker Images to Docker Hub

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# TRIGGERS - Tests on dev, Publish on main
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
on:
  # Tests on dev branch (no publishing)
  push:
    branches:
      - dev
    paths:
      - 'complex/**'
      - 'docker01/**'
      - 'docker02/**'
      - '.github/workflows/docker-publish-all.yml'

  # Tests on PRs to dev (no publishing)
  pull_request:
    branches:
      - dev
    paths:
      - 'complex/**'
      - 'docker01/**'
      - 'docker02/**'
      - '.github/workflows/docker-publish-all.yml'

  # Validation and publishing on main (from merge)
  push:
    branches:
      - main
    paths:
      - 'complex/**'
      - 'docker01/**'
      - 'docker02/**'
      - '.github/workflows/docker-publish-all.yml'
    tags:
      - 'v*.*.*'

  workflow_dispatch:
    inputs:
      images:
        description: 'Which images to publish (comma-separated: complex,docker01,docker02 or "all")'
        required: true
        default: 'all'
        type: string
      tag_suffix:
        description: 'Optional tag suffix (e.g., -beta, -rc1)'
        required: false
        type: string
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# ENVIRONMENT VARIABLES
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
env:
  REGISTRY: docker.io
  DOCKERHUB_USERNAME: ${{ secrets.DOCKER_USERNAME }}

# Cancel in-progress runs for the same workflow on the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# PERMISSIONS
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
permissions:
  contents: read
  packages: write
  security-events: write
  pull-requests: write

jobs:
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # DETECT CHANGES - Determine which images need to be built
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  detect-changes:
    name: Detect Changed Images
    runs-on: ubuntu-latest
    outputs:
      complex: ${{ steps.filter.outputs.complex }}
      docker01: ${{ steps.filter.outputs.docker01 }}
      docker02: ${{ steps.filter.outputs.docker02 }}
      any-changed: ${{ steps.check.outputs.any-changed }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            complex:
              - 'complex/**'
            docker01:
              - 'docker01/**'
            docker02:
              - 'docker02/**'

      - name: Determine if any images changed
        id: check
        run: |
          if [ "${{ steps.filter.outputs.complex }}" = "true" ] || \
             [ "${{ steps.filter.outputs.docker01 }}" = "true" ] || \
             [ "${{ steps.filter.outputs.docker02 }}" = "true" ]; then
            echo "any-changed=true" >> $GITHUB_OUTPUT
          else
            echo "any-changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Summary of changes
        run: |
          echo "### üì¶ Image Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Image | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Jenkins Custom (complex) | ${{ steps.filter.outputs.complex == 'true' && '‚úÖ Changed' || '‚è≠Ô∏è Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker01 | ${{ steps.filter.outputs.docker01 == 'true' && '‚úÖ Changed' || '‚è≠Ô∏è Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker02 | ${{ steps.filter.outputs.docker02 == 'true' && '‚úÖ Changed' || '‚è≠Ô∏è Skipped' }} |" >> $GITHUB_STEP_SUMMARY

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # BUILD & TEST - Runs on dev and main (no publishing on dev)
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  build-and-test:
    name: Build & Test ${{ matrix.image.name }}
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.any-changed == 'true'
    timeout-minutes: 60

    strategy:
      fail-fast: false
      matrix:
        image:
          - name: jenkins-custom
            context: ./complex
            dockerfile: ./complex/Dockerfile
            dockerhub_repo: redluit/jenkins-custom
            description: "Custom Jenkins with pre-installed tools (Docker, kubectl, Terraform, Ansible)"
            enabled: ${{ needs.detect-changes.outputs.complex == 'true' || github.event.inputs.images == 'all' || contains(github.event.inputs.images, 'complex') }}

          - name: docker01
            context: ./docker01
            dockerfile: ./docker01/Dockerfile
            dockerhub_repo: redluit/nov2025-docker01
            description: "Docker01 project image"
            enabled: ${{ needs.detect-changes.outputs.docker01 == 'true' || github.event.inputs.images == 'all' || contains(github.event.inputs.images, 'docker01') }}

          - name: docker02
            context: ./docker02
            dockerfile: ./docker02/Dockerfile
            dockerhub_repo: redluit/nov2025-docker02
            description: "Docker02 project image"
            enabled: ${{ needs.detect-changes.outputs.docker02 == 'true' || github.event.inputs.images == 'all' || contains(github.event.inputs.images, 'docker02') }}

    steps:
      - name: Skip if not enabled
        if: matrix.image.enabled == 'false'
        run: |
          echo "‚è≠Ô∏è Skipping ${{ matrix.image.name }} - no changes detected"
          exit 0

      - name: Checkout code
        if: matrix.image.enabled == 'true'
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        if: matrix.image.enabled == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        if: matrix.image.enabled == 'true' && github.ref == 'refs/heads/main'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract metadata
        if: matrix.image.enabled == 'true'
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ matrix.image.dockerhub_repo }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value=${{ github.event.inputs.tag_suffix }},enable=${{ github.event.inputs.tag_suffix != '' }}
          labels: |
            org.opencontainers.image.title=${{ matrix.image.name }}
            org.opencontainers.image.description=${{ matrix.image.description }}
            org.opencontainers.image.vendor=redLUIT

      - name: Build and test Docker image (dev branch)
        if: matrix.image.enabled == 'true' && github.ref != 'refs/heads/main'
        id: build-test
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.image.context }}
          file: ${{ matrix.image.dockerfile }}
          push: false
          load: true
          tags: ${{ matrix.image.name }}:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64
          build-args: |
            BUILD_DATE=${{ github.event.repository.updated_at }}
            VCS_REF=${{ github.sha }}
            VERSION=dev-${{ github.sha }}

      - name: Build and push Docker image (main branch)
        if: matrix.image.enabled == 'true' && github.ref == 'refs/heads/main'
        id: build-and-push
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.image.context }}
          file: ${{ matrix.image.dockerfile }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64
          build-args: |
            BUILD_DATE=${{ github.event.repository.updated_at }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ steps.meta.outputs.version }}

      - name: Test built image (dev branch)
        if: matrix.image.enabled == 'true' && github.ref != 'refs/heads/main' && matrix.image.name == 'jenkins-custom'
        run: |
          echo "Testing ${{ matrix.image.name }}:test image..."
          docker run -d --name test-container ${{ matrix.image.name }}:test
          sleep 10
          docker ps | grep test-container
          docker stop test-container
          docker rm test-container
          echo "‚úÖ Image test passed!"

      - name: Generate artifact attestation
        if: matrix.image.enabled == 'true' && github.ref == 'refs/heads/main'
        uses: actions/attest-build-provenance@v1
        with:
          subject-name: ${{ matrix.image.dockerhub_repo }}
          subject-digest: ${{ steps.build-and-push.outputs.digest }}
          push-to-registry: true

      - name: Image summary (dev branch - build only)
        if: matrix.image.enabled == 'true' && github.ref != 'refs/heads/main'
        run: |
          echo "### ‚úÖ ${{ matrix.image.name }} Built & Tested" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** dev" >> $GITHUB_STEP_SUMMARY
          echo "**Action:** Build and test only (not published)" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ matrix.image.name }}:test\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚ÑπÔ∏è Images are only published to Docker Hub when merged to main branch" >> $GITHUB_STEP_SUMMARY

      - name: Image summary (main branch - published)
        if: matrix.image.enabled == 'true' && github.ref == 'refs/heads/main'
        run: |
          echo "### ‚úÖ ${{ matrix.image.name }} Published to Docker Hub" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** \`${{ matrix.image.dockerhub_repo }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Digest:** \`${{ steps.build-and-push.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pull command:**" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ matrix.image.dockerhub_repo }}:latest" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # SECURITY SCAN - Scan published images (main branch only)
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  security-scan:
    name: Security Scan ${{ matrix.image.name }}
    runs-on: ubuntu-latest
    needs: build-and-test
    if: success() && github.ref == 'refs/heads/main'
    timeout-minutes: 30

    strategy:
      fail-fast: false
      matrix:
        image:
          - name: jenkins-custom
            repo: redluit/jenkins-custom
          - name: docker01
            repo: redluit/nov2025-docker01
          - name: docker02
            repo: redluit/nov2025-docker02

    steps:
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ matrix.image.repo }}:latest
          format: 'sarif'
          output: 'trivy-results-${{ matrix.image.name }}.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results-${{ matrix.image.name }}.sarif'
          category: 'trivy-${{ matrix.image.name }}'

      - name: Run Trivy for table output
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ matrix.image.repo }}:latest
          format: 'table'
          severity: 'CRITICAL,HIGH'

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # TEST PUBLISHED IMAGES - Verify published images (main only)
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  test-published:
    name: Test Published Images
    runs-on: ubuntu-latest
    needs: build-and-test
    if: success() && github.ref == 'refs/heads/main'
    timeout-minutes: 20

    steps:
      - name: Test Jenkins Custom image
        if: needs.detect-changes.outputs.complex == 'true'
        run: |
          echo "Testing Jenkins Custom image..."
          docker pull redluit/jenkins-custom:latest

          docker run -d \
            --name jenkins-test \
            -p 8080:8080 \
            -p 50000:50000 \
            redluit/jenkins-custom:latest

          echo "Waiting for Jenkins to start..."
          for i in {1..36}; do
            if curl -f http://localhost:8080/login 2>/dev/null; then
              echo "‚úÖ Jenkins is responding!"
              break
            fi
            echo "Waiting for Jenkins... ($i/36)"
            sleep 5
          done

          # Verify tools are installed
          echo "Verifying installed tools..."
          docker exec jenkins-test git --version
          docker exec jenkins-test curl --version
          docker exec jenkins-test python3 --version
          docker exec jenkins-test kubectl version --client 2>/dev/null || true
          docker exec jenkins-test terraform version 2>/dev/null || true

          docker stop jenkins-test
          docker rm jenkins-test

          echo "‚úÖ Jenkins Custom image test passed!"

      - name: Test Docker01 image
        if: needs.detect-changes.outputs.docker01 == 'true'
        run: |
          echo "Testing Docker01 image..."
          docker pull redluit/nov2025-docker01:latest
          docker run --rm redluit/nov2025-docker01:latest echo "‚úÖ Docker01 image works!"

      - name: Test Docker02 image
        if: needs.detect-changes.outputs.docker02 == 'true'
        run: |
          echo "Testing Docker02 image..."
          docker pull redluit/nov2025-docker02:latest
          docker run --rm redluit/nov2025-docker02:latest echo "‚úÖ Docker02 image works!"

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # NOTIFICATION - Final summary
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  notify:
    name: Workflow Summary
    runs-on: ubuntu-latest
    needs: [build-and-test, security-scan, test-published]
    if: always()

    steps:
      - name: Generate summary (dev branch)
        if: github.ref != 'refs/heads/main'
        run: |
          echo "## üî® Docker Images Built & Tested (Dev Branch)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ‚ÑπÔ∏è Testing Phase" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Images were built and tested locally but **not published** to Docker Hub." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**To publish these images:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Merge this PR/branch to \`main\`" >> $GITHUB_STEP_SUMMARY
          echo "2. Images will automatically be published to Docker Hub" >> $GITHUB_STEP_SUMMARY
          echo "3. Security scans and attestations will be generated" >> $GITHUB_STEP_SUMMARY

      - name: Generate summary (main branch)
        if: github.ref == 'refs/heads/main'
        run: |
          echo "## üöÄ Docker Images Published to Docker Hub" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Published Images" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Image | Repository | Command |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|------------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Jenkins Custom | \`redluit/jenkins-custom\` | \`docker pull redluit/jenkins-custom:latest\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker01 | \`redluit/nov2025-docker01\` | \`docker pull redluit/nov2025-docker01:latest\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker02 | \`redluit/nov2025-docker02\` | \`docker pull redluit/nov2025-docker02:latest\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**View on Docker Hub:**" >> $GITHUB_STEP_SUMMARY
          echo "- [Jenkins Custom](https://hub.docker.com/r/redluit/jenkins-custom)" >> $GITHUB_STEP_SUMMARY
          echo "- [Docker01](https://hub.docker.com/r/redluit/nov2025-docker01)" >> $GITHUB_STEP_SUMMARY
          echo "- [Docker02](https://hub.docker.com/r/redluit/nov2025-docker02)" >> $GITHUB_STEP_SUMMARY

      - name: Check workflow status
        run: |
          if [ "${{ job.status }}" != "success" ]; then
            echo "‚ùå Some steps failed!"
            exit 1
          else
            if [ "${{ github.ref }}" = "refs/heads/main" ]; then
              echo "‚úÖ All images published successfully!"
            else
              echo "‚úÖ All images built and tested successfully!"
            fi
          fi
