name: Build, Test & Publish Docker Image

on:
  pull_request:
    branches:
      - dev
    types:
      - opened
      - synchronize
      - reopened

  push:
    branches:
      - main
    tags:
      - 'v*.*.*'

  workflow_dispatch:
    inputs:
      platforms:
        description: 'Build platforms'
        required: true
        type: choice
        default: 'linux/amd64'
        options:
          - 'linux/amd64'
          - 'linux/amd64,linux/arm64'

env:
  REGISTRY: docker.io
  PYTHON_VERSION: '3.12'
  CACHE_VERSION: v1
  # Default to single platform for faster builds
  BUILD_PLATFORMS: linux/amd64

# Cancel in-progress runs for the same workflow
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # VALIDATE JOB
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Dockerfile
        run: |
          if [ ! -f ./docker01/Dockerfile ]; then
            echo "âŒ Dockerfile not found at ./docker01/Dockerfile"
            exit 1
          fi
          echo "âœ… Dockerfile found"
          
      - name: Validate required files
        run: |
          if [ ! -f requirements.txt ]; then
            echo "âš ï¸ requirements.txt not found"
          fi
          
          if [ ! -d tests ]; then
            echo "âŒ tests directory not found"
            exit 1
          fi
          echo "âœ… Required files validated"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # TEST JOB
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test:
    name: Run Tests & Linting
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'pull_request'
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install flake8 pytest pytest-cov ruff
          if [ -f requirements.txt ]; then 
            pip install -r requirements.txt
          fi
      
      - name: Run unit tests with coverage
        run: |
          echo "Running test suite with coverage..."
          pytest tests/ -v --cov=. --cov-report=xml --cov-report=term
          
      - name: Run code quality checks
        run: |
          echo "Running Ruff..."
          ruff check . || true
          
          echo "Running Flake8..."
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # BUILD & SCAN JOB
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-and-scan:
    name: Build & Security Scan
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'pull_request'
    timeout-minutes: 30

    permissions:
      security-events: write
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKER_USERNAME }}/${{ secrets.IMAGE_NAME }}
          tags: |
            type=ref,event=pr,prefix=pr-
            type=sha,prefix=pr-{{branch}}-

      - name: Build Docker image (validation only - AMD64)
        id: build-image
        uses: docker/build-push-action@v5
        with:
          context: ./docker01
          file: ./docker01/Dockerfile
          push: false
          load: true
          platforms: linux/amd64
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=build-pr
          cache-to: type=gha,mode=max,scope=build-pr

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Semgrep SAST Scan â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run Semgrep SAST scan
        uses: docker://returntocorp/semgrep:latest
        continue-on-error: true
        with:
          entrypoint: /bin/sh
          args: -c "semgrep ci --suppress-errors --sarif --config auto > semgrep-results.sarif || true"
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

      - name: Upload Semgrep results
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        continue-on-error: true
        with:
          sarif_file: semgrep-results.sarif
          category: 'semgrep-sast'

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Trivy Vulnerability Scan â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          scan-type: 'image'
          image-ref: ${{ fromJSON(steps.meta.outputs.json).tags[0] }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: Upload Trivy results
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        continue-on-error: true
        with:
          sarif_file: trivy-results.sarif
          category: 'trivy-container-scan'

      - name: Generate PR summary
        if: always()
        run: |
          echo "## âœ… Build & Security Scan Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Tests passed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Docker image built successfully" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Security scans completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Build Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Platform:** linux/amd64" >> $GITHUB_STEP_SUMMARY
          echo "- **Tags:** \`${{ steps.meta.outputs.tags }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Image will be published after merge to main**" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # PUBLISH JOB
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  publish:
    name: Publish Docker Image
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    timeout-minutes: 60
    environment:
      name: production
      url: https://hub.docker.com/r/${{ secrets.DOCKER_USERNAME }}/${{ secrets.IMAGE_NAME }}

    permissions:
      security-events: write
      contents: write
      packages: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Pre-publish validation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Run pre-publish tests
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pytest ruff
          
          echo "ðŸ§ª Running pre-publish validation..."
          pytest tests/ -v --tb=short
          ruff check . || true
          
          echo "âœ… Pre-publish validation passed"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Semgrep scan â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run Semgrep code scan
        uses: docker://returntocorp/semgrep:latest
        continue-on-error: true
        with:
          entrypoint: /bin/sh
          args: -c "semgrep ci --suppress-errors --sarif --config auto > semgrep-results.sarif || true"
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

      - name: Upload Semgrep results
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        continue-on-error: true
        with:
          sarif_file: semgrep-results.sarif
          category: 'semgrep-production-scan'

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Docker setup for multi-platform â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: all

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: network=host
          buildkitd-flags: --debug

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
        timeout-minutes: 5

      - name: Verify Docker Hub authentication
        run: |
          echo "âœ… Successfully authenticated with Docker Hub"
          echo "ðŸ“¦ Target repository: ${{ secrets.DOCKER_USERNAME }}/${{ secrets.IMAGE_NAME }}"

      - name: Verify Docker Hub repository exists
        run: |
          USERNAME="${{ secrets.DOCKER_USERNAME }}"
          REPO_NAME="${{ secrets.IMAGE_NAME }}"
          FULL_REPO="${USERNAME}/${REPO_NAME}"
          
          echo "Checking if repository ${FULL_REPO} exists..."
          
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            --retry 3 \
            --retry-delay 2 \
            --max-time 10 \
            "https://hub.docker.com/v2/repositories/${FULL_REPO}/")
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Repository verified: https://hub.docker.com/r/${FULL_REPO}"
          elif [ "$HTTP_CODE" = "404" ]; then
            echo "âŒ ERROR: Repository does not exist!"
            echo "Create at: https://hub.docker.com/repository/create"
            exit 1
          else
            echo "âš ï¸ Could not verify (HTTP ${HTTP_CODE}), proceeding..."
          fi

      - name: Determine build platforms
        id: platforms
        run: |
          # Default to AMD64 only for faster builds
          PLATFORMS="${{ env.BUILD_PLATFORMS }}"
          
          # Override from workflow dispatch if available
          if [ "${{ github.event.inputs.platforms }}" != "" ]; then
            PLATFORMS="${{ github.event.inputs.platforms }}"
          fi
          
          echo "platforms=${PLATFORMS}" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Building for platforms: ${PLATFORMS}"

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKER_USERNAME }}/${{ secrets.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha,prefix=main-,format=short
            type=raw,value=latest,enable={{is_default_branch}}
          labels: |
            org.opencontainers.image.title=${{ secrets.IMAGE_NAME }}
            org.opencontainers.image.description=Production Docker Image
            org.opencontainers.image.vendor=${{ github.repository_owner }}

      - name: Show tags to be published
        run: |
          echo "=== Tags to Publish ==="
          echo "${{ steps.meta.outputs.tags }}"
          echo "======================="
          echo "Platforms: ${{ steps.platforms.outputs.platforms }}"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Build for scanning (AMD64 only) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Build Docker image for scanning (AMD64)
        id: build-scan
        uses: docker/build-push-action@v5
        with:
          context: ./docker01
          file: ./docker01/Dockerfile
          push: false
          load: true
          platforms: linux/amd64
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=build-main
          cache-to: type=gha,mode=max,scope=build-main
          build-args: |
            BUILD_DATE=${{ github.event.repository.updated_at }}
            VCS_REF=${{ github.sha }}

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          scan-type: 'image'
          image-ref: ${{ fromJSON(steps.meta.outputs.json).tags[0] }}
          format: 'sarif'
          output: 'trivy-production.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: Upload Trivy production scan
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        continue-on-error: true
        with:
          sarif_file: trivy-production.sarif
          category: 'trivy-production-scan'

      - name: Run Trivy table output
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          scan-type: 'image'
          image-ref: ${{ fromJSON(steps.meta.outputs.json).tags[0] }}
          format: 'table'
          severity: 'CRITICAL,HIGH'

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Build and push (with platform support) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Build and push Docker image
        id: build-and-push
        uses: docker/build-push-action@v5
        with:
          context: ./docker01
          file: ./docker01/Dockerfile
          push: true
          platforms: ${{ steps.platforms.outputs.platforms }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=build-main
          cache-to: type=gha,mode=max,scope=build-main
          build-args: |
            BUILD_DATE=${{ github.event.repository.updated_at }}
            VCS_REF=${{ github.sha }}
          provenance: false
          sbom: false

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Post-publish verification â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Verify published image
        run: |
          PRIMARY_TAG="${{ fromJSON(steps.meta.outputs.json).tags[0] }}"
          
          echo "ðŸ” Verifying published image: ${PRIMARY_TAG}"
          
          # Wait a bit for the image to be fully available
          sleep 10
          
          # Check if image manifest exists
          docker buildx imagetools inspect "${PRIMARY_TAG}" || {
            echo "âš ï¸ Could not inspect image, but push completed successfully"
          }
          
          echo "âœ… Image publish verification complete"

      - name: List available platforms
        run: |
          PRIMARY_TAG="${{ fromJSON(steps.meta.outputs.json).tags[0] }}"
          
          echo "ðŸ“¦ Available platforms for ${PRIMARY_TAG}:"
          docker buildx imagetools inspect "${PRIMARY_TAG}" --raw | \
            jq -r '.manifests[]?.platform | "\(.os)/\(.architecture)"' || \
            echo "Could not list platforms"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Generate summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Generate deployment summary
        if: always()
        run: |
          STATUS="${{ job.status }}"
          if [ "$STATUS" = "success" ]; then
            EMOJI="ðŸš€"
            STATUS_TEXT="Successfully Published"
          else
            EMOJI="âŒ"
            STATUS_TEXT="Failed"
          fi
          
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ${EMOJI} Docker Image ${STATUS_TEXT}!
          
          ### ðŸ“¦ Image Details
          - **Registry:** Docker Hub (docker.io)
          - **Repository:** [${{ secrets.DOCKER_USERNAME }}/${{ secrets.IMAGE_NAME }}](https://hub.docker.com/r/${{ secrets.DOCKER_USERNAME }}/${{ secrets.IMAGE_NAME }})
          - **Digest:** \`${{ steps.build-and-push.outputs.digest }}\`
          - **Platforms:** \`${{ steps.platforms.outputs.platforms }}\`
          
          ### ðŸ·ï¸ Published Tags
          \`\`\`
          ${{ steps.meta.outputs.tags }}
          \`\`\`
          
          ### ðŸ”— Pull Command
          \`\`\`bash
          docker pull ${{ fromJSON(steps.meta.outputs.json).tags[0] }}
          \`\`\`
          
          ### ðŸ“Š Quality & Security
          - âœ… Pre-publish tests passed
          - âœ… Semgrep SAST scan completed
          - âœ… Trivy vulnerability scan completed
          - ðŸ“‹ [View Security Reports](${{ github.server_url }}/${{ github.repository }}/security/code-scanning)
          
          ### ðŸ“ˆ Deployment Info
          - **Commit:** ${{ github.sha }}
          - **Branch:** ${{ github.ref_name }}
          - **Triggered by:** ${{ github.actor }}
          - **Build time:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          ---
          âœ¨ **Image is available on Docker Hub!**
          
          **Note:** If you need ARM64 support, trigger a manual workflow run and select \`linux/amd64,linux/arm64\` as the platform.
          EOF