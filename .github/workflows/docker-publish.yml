name: Build, Test & Publish Docker Image

on:
  pull_request:
    branches:
      - main
      - dev
    types:
      - opened
      - synchronize
      - reopened

  push:
    branches:
      - main
    tags:
      - 'v*.*.*'

  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - staging
          - production

env:
  REGISTRY: docker.io
  PYTHON_VERSION: '3.12'
  CACHE_VERSION: v1

# Cancel in-progress runs for the same workflow on the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # VALIDATE JOB - Quick validation checks
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Validate Dockerfile
        run: |
          if [ ! -f ./docker01/Dockerfile ]; then
            echo "âŒ Dockerfile not found at ./docker01/Dockerfile"
            exit 1
          fi
          echo "âœ… Dockerfile found"
          
      - name: Validate required files
        run: |
          if [ ! -f requirements.txt ]; then
            echo "âš ï¸ requirements.txt not found"
          fi
          
          if [ ! -d tests ]; then
            echo "âŒ tests directory not found"
            exit 1
          fi
          echo "âœ… Required files validated"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # TEST JOB - Comprehensive testing
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test:
    name: Run Tests & Linting
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'pull_request'
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@0a5c61591373683505ea898e09a3ea4f39ef2b9c # v5.0.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'
      
      - name: Cache Python dependencies
        uses: actions/cache@13aacd865c20de90d75de3b17ebe84f7a17d57d2 # v4.0.0
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ env.CACHE_VERSION }}-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ env.CACHE_VERSION }}-
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install flake8 pytest pytest-cov pytest-xdist ruff safety bandit
          if [ -f requirements.txt ]; then 
            pip install -r requirements.txt
          fi
      
      - name: Run security checks on dependencies
        continue-on-error: true
        run: |
          echo "Running Safety check..."
          safety check --json || true
          
          echo "Running Bandit security scan..."
          bandit -r . -f json -o bandit-report.json || true

      - name: Run unit tests with coverage
        run: |
          echo "Running test suite with coverage..."
          pytest tests/ -v \
            --cov=. \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term \
            --junit-xml=test-results.xml \
            -n auto
          
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@5d5d22a31266ced268874388b861e4b58bb5c2f3 # v4.3.1
        with:
          name: test-results
          path: |
            test-results.xml
            htmlcov/
          retention-days: 30

      - name: Run code quality checks
        run: |
          echo "Running Ruff..."
          ruff check . --output-format=github
          
          echo "Running Flake8..."
          flake8 . \
            --count \
            --select=E9,F63,F7,F82 \
            --show-source \
            --statistics \
            --format=default

      - name: Comment test results on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        continue-on-error: true
        with:
          script: |
            const fs = require('fs');
            const comment = `## ðŸ§ª Test Results
            
            âœ… All tests passed successfully!
            
            See the full test report in the workflow artifacts.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # BUILD & SCAN JOB - Security scanning
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-and-scan:
    name: Build & Security Scan
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'pull_request'
    timeout-minutes: 30

    permissions:
      security-events: write
      contents: read
      pull-requests: write

    outputs:
      image-digest: ${{ steps.build-image.outputs.digest }}
      image-tags: ${{ steps.meta.outputs.tags }}

    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@f95db51fddba0c2d1ec667646a06c2ce06100226 # v3.0.0
        with:
          driver-opts: |
            network=host
            image=moby/buildkit:latest

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@8e5442c4ef9f78752691e2d8f8d19755c6f78e81 # v5.5.1
        with:
          images: ${{ secrets.DOCKER_USERNAME }}/${{ secrets.IMAGE_NAME }}
          tags: |
            type=ref,event=pr,prefix=pr-
            type=sha,prefix=pr-{{branch}}-

      - name: Build Docker image (validation only)
        id: build-image
        uses: docker/build-push-action@4a13e500e55cf31b7a5d59a38ab2040ab0f42f56 # v5.1.0
        with:
          context: ./docker01
          file: ./docker01/Dockerfile
          push: false
          load: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=build-pr
          cache-to: type=gha,mode=max,scope=build-pr
          build-args: |
            BUILD_DATE=${{ github.event.repository.updated_at }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ steps.meta.outputs.version }}

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Semgrep SAST Scan â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run Semgrep SAST scan
        uses: docker://returntocorp/semgrep:1.52.0
        continue-on-error: true
        with:
          entrypoint: /bin/sh
          args: -c "semgrep ci --suppress-errors --sarif --config auto --config p/security-audit --config p/secrets --config p/owasp-top-ten > semgrep-results.sarif || true"
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

      - name: Upload Semgrep results
        if: always()
        uses: github/codeql-action/upload-sarif@cdcdbb579706841c47f7063dda365e292e5cad7a # v2.13.4
        continue-on-error: true
        with:
          sarif_file: semgrep-results.sarif
          category: 'semgrep-sast'

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Trivy Vulnerability Scan â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run Trivy vulnerability scanner (SARIF)
        uses: aquasecurity/trivy-action@2b6a709cf9c4025c5438138008beaddbb02086f0 # 0.14.0
        continue-on-error: true
        with:
          scan-type: 'image'
          image-ref: ${{ fromJSON(steps.meta.outputs.json).tags[0] }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'
          vuln-type: 'os,library'
          scanners: 'vuln,secret,config'
          timeout: '10m'

      - name: Upload Trivy results
        if: always()
        uses: github/codeql-action/upload-sarif@cdcdbb579706841c47f7063dda365e292e5cad7a # v2.13.4
        continue-on-error: true
        with:
          sarif_file: trivy-results.sarif
          category: 'trivy-container-scan'

      - name: Run Trivy vulnerability scanner (JSON)
        uses: aquasecurity/trivy-action@2b6a709cf9c4025c5438138008beaddbb02086f0 # 0.14.0
        with:
          scan-type: 'image'
          image-ref: ${{ fromJSON(steps.meta.outputs.json).tags[0] }}
          format: 'json'
          output: 'trivy-results.json'
          severity: 'CRITICAL,HIGH'

      - name: Parse Trivy results
        if: always()
        continue-on-error: true
        run: |
          if [ -f trivy-results.json ]; then
            CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy-results.json)
            HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' trivy-results.json)
            
            echo "CRITICAL_VULNS=${CRITICAL}" >> $GITHUB_ENV
            echo "HIGH_VULNS=${HIGH}" >> $GITHUB_ENV
            
            echo "### ðŸ” Vulnerability Summary" >> $GITHUB_STEP_SUMMARY
            echo "- Critical: ${CRITICAL}" >> $GITHUB_STEP_SUMMARY
            echo "- High: ${HIGH}" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Trivy scan results
        if: always()
        uses: actions/upload-artifact@5d5d22a31266ced268874388b861e4b58bb5c2f3 # v4.3.1
        with:
          name: trivy-scan-results
          path: trivy-results.json
          retention-days: 30

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Grype Vulnerability Scan (Alternative) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run Grype vulnerability scanner
        uses: anchore/scan-action@3343887d815d7b07465f6fdcd395bd66508d486a # v3.6.4
        continue-on-error: true
        with:
          image: ${{ fromJSON(steps.meta.outputs.json).tags[0] }}
          fail-build: false
          severity-cutoff: critical
          output-format: sarif

      - name: Upload Grype results
        if: always()
        uses: github/codeql-action/upload-sarif@cdcdbb579706841c47f7063dda365e292e5cad7a # v2.13.4
        continue-on-error: true
        with:
          sarif_file: ${{ steps.scan.outputs.sarif }}
          category: 'grype-container-scan'

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Generate PR Comment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Generate PR comment with scan results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        continue-on-error: true
        with:
          script: |
            const criticalVulns = process.env.CRITICAL_VULNS || '0';
            const highVulns = process.env.HIGH_VULNS || '0';
            
            const status = (criticalVulns === '0' && highVulns === '0') ? 'âœ…' : 'âš ï¸';
            
            const comment = `## ${status} Security Scan Results
            
            ### ðŸ“¦ Docker Image Built Successfully
            - **Tags:** \`${{ steps.meta.outputs.tags }}\`
            - **Image will be published after merge to main**
            
            ### ðŸ”’ Vulnerability Summary
            | Severity | Count |
            |----------|-------|
            | Critical | ${criticalVulns} |
            | High     | ${highVulns} |
            
            ### ðŸ“Š Security Tools Used
            - âœ… Semgrep SAST Analysis
            - âœ… Trivy Container Scan
            - âœ… Grype Vulnerability Scan
            - âœ… Dependency Security Check
            
            [View detailed security reports â†’](${{ github.server_url }}/${{ github.repository }}/security/code-scanning)
            
            ---
            *This image has not been published to Docker Hub yet. It will be published after PR is merged to main.*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Generate PR summary
        if: always()
        run: |
          echo "## âœ… Build & Security Scan Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Tests passed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Docker image built successfully" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Security scans completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Build Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Tags:** \`${{ steps.meta.outputs.tags }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Digest:** \`${{ steps.build-image.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Image will be published after merge to main**" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # PUBLISH JOB - Production deployment
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  publish:
    name: Publish Docker Image
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    timeout-minutes: 45
    environment:
      name: production
      url: https://hub.docker.com/r/${{ secrets.DOCKER_USERNAME }}/${{ secrets.IMAGE_NAME }}

    permissions:
      security-events: write
      contents: write
      packages: write
      id-token: write

    outputs:
      image-digest: ${{ steps.build-and-push.outputs.digest }}
      image-tags: ${{ steps.meta.outputs.tags }}

    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          fetch-depth: 0

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Pre-publish validation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@0a5c61591373683505ea898e09a3ea4f39ef2b9c # v5.0.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Run pre-publish tests
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pytest ruff
          
          echo "ðŸ§ª Running pre-publish validation..."
          pytest tests/ -v --tb=short
          ruff check .
          
          echo "âœ… Pre-publish validation passed"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Security scans â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run Semgrep code scan
        uses: docker://returntocorp/semgrep:1.52.0
        continue-on-error: true
        with:
          entrypoint: /bin/sh
          args: -c "semgrep ci --suppress-errors --sarif --config auto --config p/security-audit > semgrep-results.sarif || true"
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

      - name: Upload Semgrep results
        if: always()
        uses: github/codeql-action/upload-sarif@cdcdbb579706841c47f7063dda365e292e5cad7a # v2.13.4
        continue-on-error: true
        with:
          sarif_file: semgrep-results.sarif
          category: 'semgrep-production-scan'

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Docker setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Set up QEMU
        uses: docker/setup-qemu-action@68827325e0b33c7199eb31dd4e31fbe9023e06e3 # v3.0.0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@f95db51fddba0c2d1ec667646a06c2ce06100226 # v3.0.0
        with:
          driver-opts: |
            network=host
            image=moby/buildkit:latest

      - name: Login to Docker Hub
        uses: docker/login-action@343f7c4344506bcbf9b4de18042ae17996df046d # v3.0.0
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
        timeout-minutes: 5

      - name: Verify Docker Hub authentication
        run: |
          echo "âœ… Successfully authenticated with Docker Hub"
          echo "ðŸ“¦ Target repository: ${{ secrets.DOCKER_USERNAME }}/${{ secrets.IMAGE_NAME }}"

      - name: Verify Docker Hub repository exists
        run: |
          USERNAME="${{ secrets.DOCKER_USERNAME }}"
          REPO_NAME="${{ secrets.IMAGE_NAME }}"
          FULL_REPO="${USERNAME}/${REPO_NAME}"
          
          MAX_RETRIES=3
          RETRY_DELAY=5
          
          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i/$MAX_RETRIES: Checking repository ${FULL_REPO}..."
            
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              --retry 3 \
              --retry-delay 2 \
              --max-time 10 \
              "https://hub.docker.com/v2/repositories/${FULL_REPO}/")
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… Repository verified: https://hub.docker.com/r/${FULL_REPO}"
              exit 0
            elif [ "$HTTP_CODE" = "404" ]; then
              echo "âŒ ERROR: Repository does not exist!"
              echo ""
              echo "Create the repository at: https://hub.docker.com/repository/create"
              echo "Repository name: ${REPO_NAME}"
              exit 1
            fi
            
            if [ $i -lt $MAX_RETRIES ]; then
              echo "âš ï¸ Received HTTP ${HTTP_CODE}, retrying in ${RETRY_DELAY}s..."
              sleep $RETRY_DELAY
            fi
          done
          
          echo "âš ï¸ Could not verify repository after $MAX_RETRIES attempts, proceeding anyway..."

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@8e5442c4ef9f78752691e2d8f8d19755c6f78e81 # v5.5.1
        with:
          images: ${{ secrets.DOCKER_USERNAME }}/${{ secrets.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha,prefix=main-,format=short
            type=raw,value=latest,enable={{is_default_branch}}
          labels: |
            org.opencontainers.image.title=${{ secrets.IMAGE_NAME }}
            org.opencontainers.image.description=Production Docker Image
            org.opencontainers.image.vendor=${{ github.repository_owner }}

      - name: Show tags to be published
        run: |
          echo "=== Tags to Publish ==="
          echo "${{ steps.meta.outputs.tags }}"
          echo "======================="

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Build and scan before push â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Build Docker image for scanning
        id: build-scan
        uses: docker/build-push-action@4a13e500e55cf31b7a5d59a38ab2040ab0f42f56 # v5.1.0
        with:
          context: ./docker01
          file: ./docker01/Dockerfile
          push: false
          load: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=build-main
          cache-to: type=gha,mode=max,scope=build-main
          build-args: |
            BUILD_DATE=${{ github.event.repository.updated_at }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ steps.meta.outputs.version }}

      - name: Run Trivy vulnerability scanner (final check)
        uses: aquasecurity/trivy-action@2b6a709cf9c4025c5438138008beaddbb02086f0 # 0.14.0
        with:
          scan-type: 'image'
          image-ref: ${{ fromJSON(steps.meta.outputs.json).tags[0] }}
          format: 'sarif'
          output: 'trivy-production.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '0'
          timeout: '15m'

      - name: Upload Trivy production scan
        if: always()
        uses: github/codeql-action/upload-sarif@cdcdbb579706841c47f7063dda365e292e5cad7a # v2.13.4
        continue-on-error: true
        with:
          sarif_file: trivy-production.sarif
          category: 'trivy-production-scan'

      - name: Run Trivy for blocking vulnerabilities
        uses: aquasecurity/trivy-action@2b6a709cf9c4025c5438138008beaddbb02086f0 # 0.14.0
        with:
          scan-type: 'image'
          image-ref: ${{ fromJSON(steps.meta.outputs.json).tags[0] }}
          format: 'table'
          severity: 'CRITICAL'
          exit-code: '1'
        continue-on-error: false

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Push to registry â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Build and push Docker image to Docker Hub
        id: build-and-push
        uses: docker/build-push-action@4a13e500e55cf31b7a5d59a38ab2040ab0f42f56 # v5.1.0
        with:
          context: ./docker01
          file: ./docker01/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha,scope=build-main
          cache-to: type=gha,mode=max,scope=build-main
          build-args: |
            BUILD_DATE=${{ github.event.repository.updated_at }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ steps.meta.outputs.version }}
          provenance: true
          sbom: true

      - name: Generate SBOM
        uses: anchore/sbom-action@78fc58e266e87a38d4194b2137a3d4e9bcaf7ca1 # v0.14.3
        with:
          image: ${{ fromJSON(steps.meta.outputs.json).tags[0] }}
          format: spdx-json
          output-file: sbom.spdx.json

      - name: Upload SBOM
        uses: actions/upload-artifact@5d5d22a31266ced268874388b861e4b58bb5c2f3 # v4.3.1
        with:
          name: sbom
          path: sbom.spdx.json
          retention-days: 90

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Post-publish verification â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Verify published image
        run: |
          PRIMARY_TAG="${{ fromJSON(steps.meta.outputs.json).tags[0] }}"
          
          echo "ðŸ” Verifying published image: ${PRIMARY_TAG}"
          
          # Pull the image to verify it's accessible
          docker pull "${PRIMARY_TAG}"
          
          # Verify image runs
          docker run --rm "${PRIMARY_TAG}" --version || echo "Version check not applicable"
          
          echo "âœ… Image verification successful"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Create GitHub Release â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@de2c0eb89ae2a093876385947365aca7b0e5f844 # v1
        with:
          generate_release_notes: true
          files: |
            sbom.spdx.json
            trivy-production.sarif
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Notifications â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Generate deployment summary
        if: always()
        run: |
          STATUS="${{ job.status }}"
          if [ "$STATUS" = "success" ]; then
            EMOJI="ðŸš€"
            STATUS_TEXT="Successfully Published"
          else
            EMOJI="âŒ"
            STATUS_TEXT="Failed"
          fi
          
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ${EMOJI} Docker Image ${STATUS_TEXT}!
          
          ### ðŸ“¦ Image Details
          - **Registry:** Docker Hub (docker.io)
          - **Repository:** [${{ secrets.DOCKER_USERNAME }}/${{ secrets.IMAGE_NAME }}](https://hub.docker.com/r/${{ secrets.DOCKER_USERNAME }}/${{ secrets.IMAGE_NAME }})
          - **Digest:** \`${{ steps.build-and-push.outputs.digest }}\`
          - **Platforms:** linux/amd64, linux/arm64
          
          ### ðŸ·ï¸ Published Tags
          \`\`\`
          ${{ steps.meta.outputs.tags }}
          \`\`\`
          
          ### ðŸ”— Pull Command
          \`\`\`bash
          docker pull ${{ fromJSON(steps.meta.outputs.json).tags[0] }}
          \`\`\`
          
          ### ðŸ“Š Quality & Security
          - âœ… Pre-publish tests passed
          - âœ… Semgrep SAST scan completed
          - âœ… Trivy vulnerability scan completed
          - âœ… SBOM generated
          - âœ… Image provenance attached
          - ðŸ“‹ [View Security Reports](${{ github.server_url }}/${{ github.repository }}/security/code-scanning)
          
          ### ðŸ” Supply Chain Security
          - Software Bill of Materials (SBOM) generated
          - Image signed with provenance
          - Multi-platform build (amd64, arm64)
          
          ### ðŸ“ˆ Deployment Info
          - **Commit:** ${{ github.sha }}
          - **Branch:** ${{ github.ref_name }}
          - **Triggered by:** ${{ github.actor }}
          - **Build time:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          ---
          âœ¨ **Image is production-ready and available on Docker Hub!**
          EOF

      - name: Send Slack notification (on failure)
        if: failure() && secrets.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@e28cf165c92ffef168d23c5c9000cffc8a25e117 # v1.24.0
        with:
          payload: |
            {
              "text": "âŒ Docker image publish failed!",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "âŒ *Docker Image Publish Failed*\n\n*Repository:* ${{ github.repository }}\n*Branch:* ${{ github.ref_name }}\n*Commit:* ${{ github.sha }}\n*Actor:* ${{ github.actor }}\n\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow Run>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK